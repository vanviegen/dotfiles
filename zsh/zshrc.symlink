# Start tmux instead if we're not already in tmux, we're not in vscode and it's an interactive session
if [[ -z "$TMUX" && "$TERM_PROGRAM" != "vscode" && $- == *i* ]]; then
    if command -v tmux > /dev/null; then
        exec tmux new-session -A -s $USER-main
    else
        echo "Failed to start tmux"
    fi
fi

private "DOT=$HOME/.dotfiles"
export PATH="$DOT/bin:$PATH"

# Configuration for various tools
export COLORTERM=truecolor
export FZF_DEFAULT_COMMAND='rg --files'
export LESS='-iMSx4 -FX -R'
export PAGER=less
export EDITOR=hx
alias open=xdg-open
alias cs=rg
alias S=sudo

# History config
SAVEHIST=10000
HISTSIZE=10000
HISTFILE=~/.zsh_history
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS
setopt EXTENDED_HISTORY

# Offer to correct mistyped commands
setopt CORRECT

# Configure nix
if test -e "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"; then
    source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh 
fi

# This script was automatically generated by the broot program
# More information can be found in https://github.com/Canop/broot
# This function starts broot and executes the command
# it produces, if any.
# It's needed because some shell commands, like `cd`,
# have no useful effect if executed in a subshell.
function br {
    local cmd cmd_file code
    cmd_file=$(mktemp)
    if broot --outcmd "$cmd_file" "$@"; then
        cmd=$(<"$cmd_file")
        command rm -f "$cmd_file"
        eval "$cmd"
    else
        code=$?
        command rm -f "$cmd_file"
        return "$code"
    fi
}

# Load and initialise completion system
autoload -Uz compinit
compinit

# Load our package manager, zap
source "$HOME/.local/share/zap/zap/zap.zsh"

# Have agnoster hide our user name when it's "frank"
export DEFAULT_USER=frank
# Use the agnoster prompt
setopt promptsubst
plug agnoster/agnoster-zsh-theme

# Use esc+esc to prepend sudo/sudoedit
plug zap-zsh/sudo

# Fix keys like home and ctrl-left, and add some nice shortcuts like ctrl-x ctrl-e to edit command in editor
plug embeddedpenguin/sanekeybinds

# Show autocomplate suggestions without prompting
#plug marlonrichert/zsh-autocomplete

# Make Tab go straight to the menu and cycle there
#bindkey '\t' menu-select "$terminfo[kcbt]" menu-select
#bindkey -M menuselect '\t' menu-complete "$terminfo[kcbt]" reverse-menu-complete

# Auto-activate python environment (poetry, virtualenv, conda)
plug se-jaeger/zsh-activate-py-environment

# Fancy `cat` replacement
plug fdellwing/zsh-bat

# Syntax highlighting
plug zdharma-continuum/fast-syntax-highlighting

# Use eza instead of ls and the like
eza_params="--git --icons --classify --group-directories-first --time-style=long-iso --group --color-scale"
alias ls="eza $eza_params"
alias l="eza --git-ignore $eza_params"
alias ll="eza --all --header --long $eza_params"
alias llm="eza --all --header --long --sort=modified $eza_params"
alias la="eza -lbhHigUmuSa"
alias lx="eza -lbhHigUmuSa@"
alias lt="eza --tree $eza_params"
alias tree="eza --tree $eza_params"